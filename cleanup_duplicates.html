<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Duplicate Family Members</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Cleanup Duplicate Family Members</h1>
        
        <div class="card">
            <div class="card-body">
                <h5>Family Members List</h5>
                <div id="familyMembersList"></div>
            </div>
        </div>
        
        <div id="results" class="mt-3"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3017/api';
        
        function showResult(message, type = 'info') {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        async function loadFamilyMembers() {
            try {
                const response = await fetch(`${API_BASE_URL}/family-members/`, {
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwNzA4NDkwLCJpYXQiOjE3NjA3MDQ4OTAsImp0aSI6ImMwYjQ1MzJhNmFkYTQwZDFhYzc0ZTFkZDg5ZDA1OGQ2IiwidXNlcl9pZCI6NH0.sZ4g-HEzgwEeA5j7w9lrHUxwAEWBfQkb5adRJ-4kbVc',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayFamilyMembers(data.results);
                } else {
                    showResult('Failed to load family members', 'danger');
                }
            } catch (error) {
                showResult(`Error: ${error.message}`, 'danger');
            }
        }
        
        function displayFamilyMembers(members) {
            const container = document.getElementById('familyMembersList');
            
            if (members.length === 0) {
                container.innerHTML = '<p class="text-muted">No family members found.</p>';
                return;
            }
            
            // Group by name to find duplicates
            const grouped = {};
            members.forEach(member => {
                if (!grouped[member.name]) {
                    grouped[member.name] = [];
                }
                grouped[member.name].push(member);
            });
            
            let html = '';
            Object.keys(grouped).forEach(name => {
                const membersWithSameName = grouped[name];
                const isDuplicate = membersWithSameName.length > 1;
                
                html += `
                    <div class="card mb-3 ${isDuplicate ? 'border-warning' : ''}">
                        <div class="card-header ${isDuplicate ? 'bg-warning text-dark' : ''}">
                            <h6 class="mb-0">
                                ${name} ${isDuplicate ? '<span class="badge bg-danger">DUPLICATE</span>' : ''}
                            </h6>
                        </div>
                        <div class="card-body">
                `;
                
                membersWithSameName.forEach(member => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                            <div>
                                <strong>ID: ${member.id}</strong> - ${member.relation}
                                ${member.email ? `<br><small class="text-muted">${member.email}</small>` : ''}
                                <br><small class="text-muted">Created: ${new Date(member.created_at).toLocaleString()}</small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id}, '${member.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function deleteMember(id, name) {
            if (!confirm(`Are you sure you want to delete ${name} (ID: ${id})?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/family-members/${id}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwNzA4NDkwLCJpYXQiOjE3NjA3MDQ4OTAsImp0aSI6ImMwYjQ1MzJhNmFkYTQwZDFhYzc0ZTFkZDg5ZDA1OGQ2IiwidXNlcl9pZCI6NH0.sZ4g-HEzgwEeA5j7w9lrHUxwAEWBfQkb5adRJ-4kbVc',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showResult(`Family member ${name} (ID: ${id}) deleted successfully!`, 'success');
                    loadFamilyMembers(); // Reload the list
                } else {
                    showResult(`Failed to delete family member: ${response.status}`, 'danger');
                }
            } catch (error) {
                showResult(`Error deleting family member: ${error.message}`, 'danger');
            }
        }
        
        // Load family members on page load
        loadFamilyMembers();
    </script>
</body>
</html>
